name: OrgProject - Move linked issues to In Progress on Draft PR

on:
  workflow_call:
    inputs:
      ORG_LOGIN:
        description: "Organization login (e.g. ACME-RD)"
        required: true
        type: string
      # 二選一：給 ID（最穩）或 Title
      ORG_PROJECT_ID:
        description: "Organization Project v2 Node ID (preferred)"
        required: false
        type: string
      ORG_PROJECT_TITLE:
        description: "Organization Project v2 Title (used if ID not set)"
        required: false
        type: string

      STATUS_FIELD_NAME:
        description: "Single-select field name, usually 'Status'"
        required: true
        type: string

      # 目標選項：提供 ID（建議）或名稱（二選一）
      STATUS_OPTION_INPROGRESS_ID:
        description: "Target Status option ID (preferred)"
        required: false
        type: string
      STATUS_OPTION_INPROGRESS:
        description: "Target Status option name (supports emoji; exact match)"
        required: false
        type: string

      # 備援：若 payload 取不到 PR，caller 可傳入
      PR_NUMBER:
        description: "Fallback PR number if pull_request payload is not available"
        required: false
        type: string

    secrets:
      ORG_PROJECT_TOKEN:
        required: true

jobs:
  move:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    concurrency:
      group: ${{ github.workflow }}-${{ inputs.PR_NUMBER || github.run_id }}
      cancel-in-progress: false

    steps:
      - name: Move linked issues to In Progress (Org Project)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ORG_PROJECT_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            // ---- 0) 事件/輸入檢查 ----
            const prFromPayload = context.payload?.pull_request || null;
            const prNumber = prFromPayload?.number || ( "${{ inputs.PR_NUMBER }}".trim() ? Number("${{ inputs.PR_NUMBER }}") : null );
            if (!prNumber) {
              core.setFailed("PR number not found. Pass inputs.PR_NUMBER or ensure pull_request payload.");
              return;
            }

            const action = context.payload?.action || "";
            const isDraftEvent = prFromPayload?.draft === true || action === "converted_to_draft";
            if (!isDraftEvent) {
              core.info("Not a draft PR event. Skip.");
              return;
            }

            const orgLogin = "${{ inputs.ORG_LOGIN }}".trim();
            const projectIdInput = "${{ inputs.ORG_PROJECT_ID }}".trim();
            const projectTitleInput = "${{ inputs.ORG_PROJECT_TITLE }}".trim();
            if (!projectIdInput && !projectTitleInput) {
              core.setFailed("Either ORG_PROJECT_ID or ORG_PROJECT_TITLE must be provided.");
              return;
            }

            const statusFieldName = "${{ inputs.STATUS_FIELD_NAME }}".trim();
            const inprogIdInput   = "${{ inputs.STATUS_OPTION_INPROGRESS_ID }}".trim();
            const inprogNameInput = "${{ inputs.STATUS_OPTION_INPROGRESS }}"; // 可能含 emoji，不做 trim/lower 以保字面

            if (!inprogIdInput && !inprogNameInput) {
              core.setFailed("Provide STATUS_OPTION_INPROGRESS_ID (preferred) or STATUS_OPTION_INPROGRESS (name).");
              return;
            }

            // ---- 1) 定位 Org Project ----
            let projectId = projectIdInput || null;
            if (!projectId) {
              const orgProj = await github.graphql(`
                query($login:String!){
                  organization(login:$login){
                    projectsV2(first:100){ nodes{ id title } }
                  }
                }`, { login: orgLogin }
              );
              const p = orgProj.organization.projectsV2.nodes.find(n => n.title === projectTitleInput);
              if (!p) throw new Error(`Org Project not found by title: '${projectTitleInput}'`);
              projectId = p.id;
            }
            core.info(`Target Project: ${projectId} (${projectTitleInput || "by ID"})`);

            // ---- 2) 取得 Draft PR 關閉關鍵字對應的 issues ----
            const prInfo = await github.graphql(`
              query($owner:String!, $repo:String!, $num:Int!){
                repository(owner:$owner, name:$repo){
                  pullRequest(number:$num){
                    number
                    closingIssuesReferences(first:50){ nodes{ id number } }
                  }
                }
              }`, { owner, repo, num: prNumber }
            );
            const linked = prInfo.repository.pullRequest?.closingIssuesReferences?.nodes || [];
            if (linked.length === 0) {
              core.info("No linked issues via closing keywords. Nothing to move.");
              return;
            }
            core.info(`Linked issues: ${linked.map(i => "#" + i.number).join(", ")}`);

            // ---- 3) 取得 Project 的 Status 欄位與目標選項 ----
            const fields = await github.graphql(`
              query($pid:ID!){
                node(id:$pid){
                  ... on ProjectV2 {
                    fields(first:100){
                      nodes{
                        __typename
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options { id name }
                        }
                      }
                    }
                  }
                }
              }`, { pid: projectId }
            );

            const statusField = fields.node.fields.nodes
              .find(f => f.__typename === "ProjectV2SingleSelectField" && f.name === statusFieldName);
            if (!statusField) throw new Error(`Field not found on project: '${statusFieldName}'`);

            core.info(`Available Status options:`);
            for (const o of statusField.options) core.info(`- ${o.id} :: '${o.name}'`);

            let targetOption = null;
            if (inprogIdInput) {
              targetOption = statusField.options.find(o => o.id === inprogIdInput);
            } else {
              const want = inprogNameInput.toLowerCase();
              targetOption = statusField.options.find(o => o.name.toLowerCase() === want);
            }
            if (!targetOption) {
              throw new Error(`Target Status option not found: '${inprogIdInput || inprogNameInput}'`);
            }
            core.info(`Target option: ${targetOption.id} :: '${targetOption.name}'`);

            // ---- 4) 逐個 Issue → 若在此 Project 中且狀態不同，則更新 ----
            for (const it of linked) {
              // 4.1 取 issue 的 project item（在該 Org Project）
              const issueQ = await github.graphql(`
                query($owner:String!, $repo:String!, $num:Int!){
                  repository(owner:$owner, name:$repo){
                    issue(number:$num){
                      id
                      projectItems(first:50){
                        nodes{ id project{ id title } }
                      }
                    }
                  }
                }`, { owner, repo, num: it.number }
              );
              const issue = issueQ.repository.issue;
              const item = issue.projectItems.nodes.find(n => n.project.id === projectId);
              if (!item) {
                core.info(`Issue #${it.number} is NOT in the target project. Skip.`);
                continue;
              }

              // 4.2 冪等：查目前狀態
              const fvQ = await github.graphql(`
                query($itemId:ID!, $fieldName:String!){
                  node(id:$itemId){
                    ... on ProjectV2Item {
                      fieldValueByName(name:$fieldName){
                        __typename
                        ... on ProjectV2ItemFieldSingleSelectValue {
                          name
                          optionId
                        }
                      }
                    }
                  }
                }`, { itemId: item.id, fieldName: statusFieldName }
              );
              const current = fvQ.node.fieldValueByName;
              const currentName = current?.name || null;
              const currentId   = current?.optionId || null;

              if (currentId === targetOption.id || (currentName && currentName.toLowerCase() === targetOption.name.toLowerCase())) {
                core.info(`Issue #${it.number} already in '${targetOption.name}'. Skip.`);
                continue;
              }

              // 4.3 更新為目標狀態
              await github.graphql(`
                mutation($projectId:ID!, $itemId:ID!, $fieldId:ID!, $optId:String!){
                  updateProjectV2ItemFieldValue(
                    input:{
                      projectId:$projectId
                      itemId:$itemId
                      fieldId:$fieldId
                      value:{ singleSelectOptionId:$optId }
                    }
                  ){ clientMutationId }
                }`, {
                  projectId,
                  itemId: item.id,
                  fieldId: statusField.id,
                  optId: targetOption.id
              });

              core.info(`Moved #${it.number} → '${targetOption.name}'`);
            }

